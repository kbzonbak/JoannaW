<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<!-- 
	Mapping file autogenerated by MyEclipse Persistence Tools
-->
<hibernate-mapping>
	<joined-subclass name="bbr.b2b.logistic.ddcorders.entities.DdcOrder" table="DDCORDER" 
		entity-name="bbr.b2b.logistic.ddcorders.entities.DdcOrder" extends="bbr.b2b.logistic.buyorders.entities.Order" schema="LOGISTICA">
		<key column ="ID" />
		
		<property name="originaldeliverydate" type="java.time.LocalDateTime" column="ORIGINALDELIVERYDATE" not-null="true"/>
		<property name="currentdeliverydate" type="java.time.LocalDateTime" column="CURRENTDELIVERYDATE" not-null="true"/>
		<property name="expiration" type="java.time.LocalDateTime" column="EXPIRATION" not-null="true"/>
		<property name="needunits" type="java.lang.Double" column="NEEDUNITS" not-null="true"/>
		<property name="todeliveryunits" type="java.lang.Double" column="TODELIVERYUNITS" not-null="true"/>
		<property name="receivedunits" type="java.lang.Double" column="RECEIVEDUNITS" not-null="true"/>
		<property name="pendingunits" type="java.lang.Double" column="PENDINGUNITS" not-null="true"/>
		<property name="totalneed" type="java.lang.Double" column="TOTALNEED" not-null="true"/>	
		<property name="totaltodelivery" type="java.lang.Double" column="TOTALTODELIVERY" not-null="true"/>
		<property name="totalreceived" type="java.lang.Double" column="TOTALRECEIVED" not-null="true"/>
		<property name="totalpending" type="java.lang.Double" column="TOTALPENDING" not-null="true"/>	
		<property name="paymentdays" type="java.lang.String" column="PAYMENT_DAYS" length="250"/>
		<property name="comment" type="java.lang.String" column="COMMENT" length="250"/>
		<property name="currentstatetypedate" type="java.time.LocalDateTime" column="CURRENTSTATETYPEDATE" not-null="true"/>
		<property name="currentstatetypewho" type="java.lang.String" column="CURRENTSTATETYPEWHO" length="100" not-null="true"/>
		<property name="currentstatetypecomment" type="java.lang.String" column="CURRENTSTATETYPECOMMENT" length="250"/>
		<property name="referencenumber" type="java.lang.String" column="REFERENCENUMBER" length="50" not-null="true"/>
		<property name="dispatchguide" type="java.lang.Long" column="DISPATCH_GUIDE"/>
		<property name="reschedulingcounter" type="java.lang.Integer" column="RESCHEDULINGCOUNTER"></property>
		
		<many-to-one name="currentstatetype"
			class="bbr.b2b.logistic.ddcorders.entities.DdcOrderStateType" column="CURRENTSTATETYPE_ID"
			not-null="true"/>
			
		<many-to-one name="salelocation"
			class="bbr.b2b.logistic.locations.entities.Location" column="SALELOCATION_ID"
			not-null="false"/>
			
		<many-to-one name="currentddcdelivery"
			class="bbr.b2b.logistic.ddcdeliveries.entities.DdcDelivery" column="CURRENTDDCDELIVERY_ID"
			not-null="false"/>
			
		<sql-query name="doCalculateTotalDdcOrders">
			<![CDATA[
				WITH foo AS (
					SELECT
						ddcorder_id,
						SUM(needunits) AS needunits,
						SUM(todeliveryunits) AS todeliveryunits,
						SUM(receivedunits) AS receivedunits,
						SUM(pendingunits) AS pendingunits,
						SUM(totalneed) AS totalneed,
						SUM(totaltodelivery) AS totaltodelivery,
						SUM(totalreceived) AS totalreceived,
						SUM(totalpending) AS totalpending
					FROM
						logistica.ddcorderdetail
					WHERE
						ddcorder_id in (:ddcorderids)
					GROUP BY
						ddcorder_id)			
				UPDATE
					logistica.ddcorder
				SET
					needunits = foo.needunits,
					todeliveryunits = foo.todeliveryunits,
					receivedunits = foo.receivedunits,
					pendingunits = foo.pendingunits,
					totalneed = foo.totalneed,
					totaltodelivery = foo.totaltodelivery,
					totalreceived = foo.totalreceived,
					totalpending = foo.totalpending
				FROM
					foo
				WHERE
					id = foo.ddcorder_id;
			]]>
		</sql-query>
		
		<sql-query name="getDdcOrdersExcelReportByOrders">
			<![CDATA[
				WITH oat AS (
						SELECT DISTINCT ON (o.id)
							o.id AS order_id,
							dl.id,
							dl.value AS deliverylocationvalue,
							bx.id,
							bx.value AS boxvalue
						FROM
							logistica.ddcorder AS o LEFT JOIN
							logistica.orderattribute AS dl ON dl.order_id = o.id AND dl.attributetype = 'LOCAL_ENTREGA_DDC' LEFT JOIN
							logistica.orderattribute AS bx ON bx.order_id = o.id AND bx.attributetype = 'CAJA'
						WHERE
							o.id IN (:ddcorderids)
						ORDER BY
							o.id, dl.id, bx.id),
					 iat AS (
						SELECT DISTINCT ON (it.id)
							it.id AS item_id,
							de.id,
							de.code AS departmentcode,
							de.value AS departmentvalue,
							sc.id,
							sc.value AS shortcodevalue
						FROM
							logistica.ddcorderdetail AS od JOIN
							logistica.item AS it ON it.id = od.item_id LEFT JOIN
							logistica.itemattribute AS de ON de.item_id = it.id AND de.attributetype = 'DEPARTAMENTO' LEFT JOIN
							logistica.itemattribute AS sc ON sc.item_id = it.id AND sc.attributetype = 'CODIGO_CORTO'
						WHERE
							od.ddcorder_id IN (:ddcorderids)
						ORDER BY
							it.id, de.id, sc.id)
				SELECT DISTINCT
					o.number AS number,
					COALESCE(ot.referencenumber, '') AS referencenumber,
					ot.dispatch_guide AS dispatchguide,
					o.emitted AS emitted,
					ot.expiration AS expiration,
					ot.currentdeliverydate AS currentdeliverydate,
					vd.dni AS vendordni,
					vd.tradename AS vendortradename,
					COALESCE(oat.deliverylocationvalue, '') AS deliverylocationcode,
					COALESCE(sl.code, '') AS salelocationcode,
					COALESCE(sl.name, '') AS salelocationname,
					COALESCE(iat.departmentcode, '') AS departmentcode,
					COALESCE(iat.departmentvalue, '') AS departmentname,
					cl.dni AS clientdni,
					cl.name AS clientname,
					COALESCE(cl.address, '') AS clientaddress,
					COALESCE(cl.commune, '') AS clientcommune,
					COALESCE(cl.city, '') AS clientcity,
					COALESCE(cl.phone, '') AS clientphone,
					COALESCE(cl.email, '') AS clientemail,
					COALESCE(cl.comment, '') AS clientcomment,
					COALESCE(oat.boxvalue, '') AS boxnumber,
					it.sku AS itemsku,
					it.name AS itemname,
					COALESCE(iat.shortcodevalue, '') AS itemshortcode,
					od.ean AS itemean,
					od.normalprice AS normalprice,
					od.finalcost AS finalcost,
					od.needunits AS needunits	
				FROM
					logistica.order AS o JOIN
					logistica.ddcorder AS ot ON ot.id = o.id JOIN 
					logistica.vendor AS vd ON vd.id = o.vendor_id LEFT JOIN
					logistica.location AS sl ON sl.id = ot.salelocation_id JOIN
					logistica.client AS cl ON cl.id = o.client_id JOIN
					logistica.ddcorderdetail AS od ON od.ddcorder_id = ot.id JOIN
					logistica.item AS it ON it.id = od.item_id LEFT JOIN
					oat ON oat.order_id = o.id LEFT JOIN
					iat ON iat.item_id = it.id
				WHERE
					o.id IN (:ddcorderids)
				ORDER BY 
					o.number
				]]>
		</sql-query>
			
		<sql-query name="countDdcOrdersExcelReportByOrders">
			<![CDATA[               
			    SELECT 
			    	COUNT(ddcorder_id)
				FROM
					logistica.ddcorderdetail
				WHERE
					ddcorder_id IN (:ddcorderids)
				]]>
		</sql-query>
		
	</joined-subclass>   
</hibernate-mapping>
