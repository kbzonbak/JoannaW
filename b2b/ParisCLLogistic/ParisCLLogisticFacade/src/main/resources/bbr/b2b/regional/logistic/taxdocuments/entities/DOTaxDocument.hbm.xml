<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<!-- 
	Mapping file autogenerated by MyEclipse Persistence Tools
-->
<hibernate-mapping>
	<class name="bbr.b2b.regional.logistic.taxdocuments.entities.DOTaxDocument" table="DOTAXDOCUMENT"
		entity-name="bbr.b2b.regional.logistic.taxdocuments.entities.DOTaxDocument" schema="LOGISTICA" >
		<id name="id" type="java.lang.Long">
			<column name="ID" />
			<generator class="identity">
				<param name="sequence">DOTAXDOCUMENT_SEQUENCE</param>
				<param name="parameters">AS BIGINT CACHE 100</param>
			</generator>
		</id>

		<property name="number" type="java.lang.Long" not-null="true"></property>		
		<property name="pdfurl" type="java.lang.String"></property>
		<property name="emitted" type="timestamp"></property>
		<property name="amount" type="java.lang.Double" not-null="true"></property>
		<property name="currentstatetypedate" type="timestamp" not-null="true"></property>
		
		<many-to-one name="vendor"
			class="bbr.b2b.regional.logistic.vendors.entities.Vendor" column="VENDOR_ID"
			not-null="true" />	
		<many-to-one name="directorder"
			class="bbr.b2b.regional.logistic.directorders.entities.DirectOrder" column="DIRECTORDER_ID"
			not-null="true" />		
		<many-to-one name="currentstatetype"
			class="bbr.b2b.regional.logistic.taxdocuments.entities.DOTaxDocumentStateType" column="CURRENTSTATETYPE_ID"
			not-null="true" />
			
		<many-to-one name="doTaxDocumentTicket"
			class="bbr.b2b.regional.logistic.taxdocuments.entities.DOTaxDocumentTicket" column="DOTAXDOCUMENTTICKET_ID"/>
		
		<sql-query name="getCountOrderReportByOrder">
			<![CDATA[				
					SELECT
					i.internalcode AS iteminternalcode,
					vi.vendoritemcode AS itemvendorcode,
					i.name AS itemname,
					sum(dd.availableunits) AS itemavailableunits,
					sum(dd.receivedunits) AS itemreceivedunits
				FROM
					logistica.directorder oc JOIN
					logistica.dodelivery d on oc.dodelivery_id = d.id JOIN
					logistica.dodeliverydetail dd ON dd.dodelivery_id = d.id JOIN
					logistica.item i ON i.id = dd.item_id JOIN
					logistica.vendoritem vi ON vi.item_id = i.id AND vi.vendor_id = d.vendor_id
				WHERE
					oc.id = :doid
				GROUP BY i.internalcode, vi.vendoritemcode, i.name
				ORDER BY
					i.internalcode ASC						
			]]>
		</sql-query>
		
		<sql-query name="getCSVDOVirtualReceptionReportByOrderIds">
			<![CDATA[	
				SELECT
					d.number AS dodeliverynumber,
					dst.name AS dodeliverycurrentst,
					d.currentstdate AS dodeliverycurrentstdate,
					o.number AS donumber,
					o.requestnumber AS dorequestnumber,
					CAST('Conforme' AS VARCHAR) AS comment,
					c.name AS doclientname,
					c.rut AS doclientrut,
					c.address AS doclientaddress,
					c.commune AS doclientcommune,
					c.city AS doclientcity,
					c.phone AS doclientphone,
					i.internalcode AS iteminternalcode,
					dd.availableunits AS itemavailableunits,
					dd.receivedunits AS itemreceivedunits,
					td.number AS dotaxdocumentnumber,
					CASE 
						WHEN hc.courier_id IS NOT NULL THEN true
						ELSE false
					END AS isvendorcourier
					
				FROM
					logistica.directorder o JOIN
					logistica.client c ON c.id = o.client_id JOIN
					logistica.dodelivery d ON d.id = o.dodelivery_id JOIN
					logistica.dodeliverystatetype dst ON dst.id = d.currentstatetype_id JOIN
					logistica.dodeliverydetail dd ON dd.dodelivery_id = d.id JOIN
					logistica.item i ON i.id = dd.item_id JOIN
					logistica.dotaxdocument td ON td.directorder_id = o.id
					LEFT JOIN logistica.hiredcourier as hc ON hc.vendor_id = o.vendor_id
				WHERE
					o.id IN (:doids)
				ORDER BY
					d.number ASC							
			]]>
		</sql-query>
		
		<sql-query name="getDOTaxDocumentsByOrderIdsAndWithoutReception">
			<![CDATA[	
				SELECT
					td.id,
					td.number,
					td.emitted,
					td.amount,
					td.currentstatetypedate,
					td.vendor_id vendorid,
					td.directorder_id directorderid,
					td.currentstatetype_id currentstatetypeid,
					td.pdfurl,
					td.dotaxdocumentticket_id dotaxdocumentticketid
				FROM
					logistica.dotaxdocument td JOIN
					logistica.dotaxdocumentstatetype tdst ON tdst.id = td.currentstatetype_id
				WHERE
					td.directorder_id IN (:doids) AND tdst.code = 'W_RM_INV'				
			]]>
		</sql-query>
		
		<sql-query name="getDOTaxDocumentsById">
			<![CDATA[	
				SELECT
					td.id,
					td.number,
					td.emitted,
					td.amount,
					td.currentstatetypedate,
					td.vendor_id vendorid,
					td.directorder_id AS directorderid,
					td.currentstatetype_id AS currentstatetypeid,
					td.pdfurl,
					td.dotaxdocumentticket_id AS dotaxdocumentticketid
				FROM
					logistica.dotaxdocument AS td 
				WHERE
					td.id IN (:documentsId)				
			]]>
		</sql-query>
		
		<sql-query name="getPendingDOTaxDocumentsByTicket">
			<![CDATA[	
				SELECT
					td.id,
					td.number,
					td.emitted,
					td.amount,
					td.currentstatetypedate,
					td.vendor_id vendorid,
					td.directorder_id AS directorderid,
					td.currentstatetype_id AS currentstatetypeid,
					td.pdfurl,
					td.dotaxdocumentticket_id AS dotaxdocumentticketid
				FROM
					logistica.dotaxdocument AS td JOIN
					logistica.dotaxdocumentstatetype AS tdst ON tdst.id = td.currentstatetype_id
				WHERE
					td.dotaxdocumentticket_id = :ticketid AND tdst.code = 'PRO_DOC'
			]]>
		</sql-query>
		
		<sql-query name="getDocumentsByNumbers">
			<![CDATA[
				SELECT
					dotd.number AS dotaxdocumentnumber,
					o.number AS donumber,
					dotds.code AS state
				FROM
					logistica.dotaxdocument AS dotd JOIN
					logistica.dotaxdocumentstatetype AS dotds ON dotds.id = dotd.currentstatetype_id JOIN
					logistica.directorder AS o ON o.id = dotd.directorder_id	
				WHERE
					dotd.number IN (:numbers)	
			]]>
		</sql-query>
		
		<sql-query name="getDOInvoicePendingByDate">
			<![CDATA[
				WITH dotdstemp AS(
							SELECT
								dotds.dotaxdocument_id,
								MAX(dotds.when1) AS when1
							FROM
								logistica.directorder AS doc JOIN
								logistica.propertyvendor AS pv ON pv.vendor_id = doc.vendor_id JOIN
								logistica.dotaxdocument AS dotd ON dotd.directorder_id = doc.id JOIN
								logistica.dotaxdocumentstate AS dotds ON dotds.dotaxdocument_id = dotd.id AND
																		 dotds.dotaxdocumentstatetype_id = dotd.currentstatetype_id
							WHERE
								doc.emitted >= :since AND doc.emitted < :until AND pv.code = 'INICIO_FACT_VEVPD' AND
								doc.emitted >= to_timestamp(substring(pv.value from 1 for 10), 'YYYY-MM-DD')
							GROUP BY
								dotds.dotaxdocument_id),
					cs AS(
						SELECT DISTINCT
							ct.dodelivery_id
						FROM
							logistica.directorder AS doc JOIN
							logistica.propertyvendor AS pv ON pv.vendor_id = doc.vendor_id JOIN
							logistica.dodelivery AS dod ON dod.id = doc.dodelivery_id JOIN
							logistica.couriertag AS ct ON ct.dodelivery_id  = dod.id JOIN
							logistica.courierstate AS cs ON cs.couriertag_id = ct.id
						WHERE
							doc.emitted >= :since AND doc.emitted < :until AND pv.code = 'INICIO_FACT_VEVPD' AND
							doc.emitted >= to_timestamp(substring(pv.value from 1 for 10), 'YYYY-MM-DD') AND
							doc.courierreceived IS TRUE AND cs.description = 'RECEPCIONADO' AND cs.startdate < :maxcourierdate),
					taxok AS(
						SELECT DISTINCT
							doc.id
						FROM
							logistica.directorder AS doc JOIN
							logistica.propertyvendor AS pv ON pv.vendor_id = doc.vendor_id LEFT JOIN
							logistica.dotaxdocument AS td ON td.directorder_id = doc.id LEFT JOIN
							logistica.dotaxdocumentstatetype AS tdst ON tdst.id = td.currentstatetype_id LEFT JOIN
							dotdstemp ON dotdstemp.dotaxdocument_id = td.id 
						WHERE
							doc.emitted >= :since AND doc.emitted < :until AND pv.code = 'INICIO_FACT_VEVPD' AND
							doc.emitted >= to_timestamp(substring(pv.value from 1 for 10), 'YYYY-MM-DD') AND
							tdst.code IN ('W_RM_INV', 'C_INV', 'RM', 'PRO_DOC'))
					SELECT
						vd.id AS vendorid,
						vd.code AS vendorcode,
						vd.tradename AS vendorname,
						doc.id AS directorderid,
						doc.number AS directordernumber,
						doc.requestnumber AS directorderrequestnumber,
						doc.emitted AS directorderemitted,
						logistica.tostr(doc.emitted) AS directorderemittedstr,
						doc.currentstatetypedate AS directorderstatedate,
						logistica.tostr(doc.currentstatetypedate) AS directorderstatedatestr,
						CASE WHEN doc.totalreceived = 0.0 AND hc.vendor_id IS NOT NULL
							 THEN doc.totalneed
							 ELSE doc.totalreceived
							 END AS directordertotalreceived,
						dod.id AS dodeliveryid,
						dod.number AS dodeliverynumber,
						dod.currentstdate AS dodeliverystatedate,
						logistica.tostr(dod.currentstdate) AS dodeliverystatedatestr,
						dotd.id AS dotaxdocumentid,
						dotd.number AS dotaxdocumentnumber,
						dotd.emitted AS dotaxdocumentemitted,
						logistica.tostr(dotd.emitted) AS dotaxdocumentemittedstr,
						dotdst.id AS dotaxdocumentstateid,
						dotdst.code AS dotaxdocumentstatecode,
						dotdst.name AS dotaxdocumentstatename,
						dotd.currentstatetypedate AS dotaxdocumentstatedate,
						logistica.tostr(dotd.currentstatetypedate) AS dotaxdocumentstatedatestr,
						dotds.who AS dotaxdocumentstateusername,
						dotdst.action AS dotaxdocumentstateaction
					FROM
						logistica.directorder AS doc JOIN
						logistica.propertyvendor AS pv ON pv.vendor_id = doc.vendor_id JOIN
						logistica.vendor AS vd ON vd.id = pv.vendor_id JOIN
						logistica.directorderstatetype AS dost ON dost.id = doc.currentstatetype_id LEFT JOIN
						logistica.dodelivery AS dod ON dod.id = doc.dodelivery_id LEFT JOIN
						logistica.dotaxdocument AS dotd ON dotd.directorder_id = doc.id LEFT JOIN
						logistica.dotaxdocumentstatetype AS dotdst ON dotdst.id = dotd.currentstatetype_id LEFT JOIN
						dotdstemp ON dotdstemp.dotaxdocument_id = dotd.id LEFT JOIN
						logistica.dotaxdocumentstate AS dotds ON dotds.dotaxdocument_id = dotdstemp.dotaxdocument_id AND
																 dotds.when1 = dotdstemp.when1 LEFT JOIN
						logistica.hiredcourier AS hc ON hc.vendor_id = vd.id LEFT JOIN
						taxok as tok ON tok.id = doc.id LEFT JOIN
						cs ON cs.dodelivery_id = dod.id
					WHERE
						doc.emitted >= :since AND doc.emitted < :until AND pv.code = 'INICIO_FACT_VEVPD' AND
						doc.emitted >= to_timestamp(substring(pv.value from 1 for 10), 'YYYY-MM-DD') AND
						tok.id IS NULL AND (
									(dotd.id IS NULL AND (dost.code IN ('RECEPCIONADA', 'EXTRAVIADO') OR
														  cs.dodelivery_id IS NOT NULL)) OR
									dotdst.code = 'DOC_FAL' OR
									dotdst.code = 'PRO_DOC' OR
									dotdst.code = 'REC_VEV' OR
									dotdst.code = 'RM_REC' OR
									dotdst.code = 'DTE_VAL')
					ORDER BY
						vd.code
			]]>
		</sql-query>
		
		<sql-query name="countDOInvoicePendingByDate">
			<![CDATA[
					WITH cs AS(
							SELECT DISTINCT
								ct.dodelivery_id
							FROM
								logistica.directorder AS doc JOIN
								logistica.propertyvendor AS pv ON pv.vendor_id = doc.vendor_id JOIN
								logistica.dodelivery AS dod ON dod.id = doc.dodelivery_id JOIN
								logistica.couriertag AS ct ON ct.dodelivery_id  = dod.id JOIN
								logistica.courierstate AS cs ON cs.couriertag_id = ct.id
							WHERE
								doc.emitted >= :since AND doc.emitted < :until AND pv.code = 'INICIO_FACT_VEVPD' AND
								doc.emitted >= to_timestamp(substring(pv.value from 1 for 10), 'YYYY-MM-DD') AND
								doc.courierreceived IS TRUE AND cs.description = 'RECEPCIONADO' AND cs.startdate < :maxcourierdate),
						taxok AS(
							SELECT DISTINCT
								doc.id
							FROM
								logistica.directorder AS doc JOIN
								logistica.propertyvendor AS pv ON pv.vendor_id = doc.vendor_id LEFT JOIN
								logistica.dotaxdocument AS td ON td.directorder_id = doc.id LEFT JOIN
								logistica.dotaxdocumentstatetype AS tdst ON tdst.id = td.currentstatetype_id
							WHERE
								doc.emitted >= :since AND doc.emitted < :until AND pv.code = 'INICIO_FACT_VEVPD' AND
								doc.emitted >= to_timestamp(substring(pv.value from 1 for 10), 'YYYY-MM-DD') AND
								tdst.code IN ('W_RM_INV', 'C_INV', 'RM', 'PRO_DOC'))
					SELECT
						COUNT(doc.id)
					FROM
						logistica.directorder AS doc JOIN
						logistica.propertyvendor AS pv ON pv.vendor_id = doc.vendor_id JOIN
						logistica.directorderstatetype AS dost ON dost.id = doc.currentstatetype_id LEFT JOIN
						logistica.dodelivery AS dod ON dod.id = doc.dodelivery_id LEFT JOIN
						logistica.dotaxdocument AS dotd ON dotd.directorder_id = doc.id LEFT JOIN
						logistica.dotaxdocumentstatetype AS dotdst ON dotdst.id = dotd.currentstatetype_id LEFT JOIN
						taxok as tok ON tok.id = doc.id LEFT JOIN
						cs ON cs.dodelivery_id = dod.id
					WHERE
						doc.emitted >= :since AND doc.emitted < :until AND pv.code = 'INICIO_FACT_VEVPD' AND
						doc.emitted >= to_timestamp(substring(pv.value from 1 for 10), 'YYYY-MM-DD') AND
						tok.id IS NULL AND (
									(dotd.id IS NULL AND (dost.code IN ('RECEPCIONADA', 'EXTRAVIADO') OR
														  cs.dodelivery_id IS NOT NULL)) OR
									dotdst.code = 'DOC_FAL' OR
									dotdst.code = 'PRO_DOC' OR
									dotdst.code = 'REC_VEV' OR
									dotdst.code = 'RM_REC' OR
									dotdst.code = 'DTE_VAL')
			]]>
		</sql-query>
		
	</class>		
</hibernate-mapping>