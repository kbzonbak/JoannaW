<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<!-- 
	Mapping file autogenerated by MyEclipse Persistence Tools
-->
<hibernate-mapping>
	<class name="bbr.esb.services.entities.ContractedService" table="CONTRACTED_SERVICE" schema="public">
		<composite-id name="id" class="bbr.esb.services.entities.ContractedServiceKey">
			<key-property name="sitekey" access="field" column="SITE_ID" />
			<key-property name="servicekey" access="field" column="SERVICE_ID" />
			<key-property name="companykey" access="field" column="COMPANY_ID" />
		</composite-id>
		<property name="active" type="java.lang.Boolean" column="ACTIVE" />
		<property name="lastsentmessage" type="java.util.Date" column="LAST_MSG" length="26" />
		<property name="monitor" type="java.lang.Boolean" column="MONITOR" />
		<property name="activation" type="java.util.Date" column="ACTIVATION" length="26" />
		<property name="lastmonitored" type="java.util.Date" column="LAST_MONITORED" length="26" />
		<property name="pendingmessages" type="java.lang.Integer" column="PENDING_MSGS" />
		<property name="extratorcredentials" type="java.lang.String" column="EXTRATORCREDENTIALS" /> 
		<property name="monitoringannotation" type="java.lang.String" column="MONITORING_ANNOTATION" length="26" />
		<property name="custommaxdelayendflow" type="java.lang.Integer" column="CUSTOMMAXDELAY_ENDFLOW" />
		<property name="compresseddocument" type="java.lang.Boolean" column="COMPRESSEDDOCUMENT" />
		<property name="custom" type="java.lang.String" column="CUSTOM" />
        <many-to-one name="site" column="SITE_ID" not-null="true" insert="false" update="false" />
		<many-to-one name="service" column="SERVICE_ID" not-null="true" insert="false" update="false" />
		<many-to-one name="company" column="COMPANY_ID" not-null="true" insert="false" update="false" />
		<many-to-one name="folder" column="FOLDER_ID" not-null="true" insert="true" update="true" />
		<many-to-one name="format" column="FORMAT_ID" not-null="true" insert="true" update="true" />
		<many-to-one name="wsendpoint" column="WSENDPOINT_ID" insert="true" update="true" />
		<property name="detail" type="java.lang.String" column="DETAIL" length="2500" />
       
        <sql-query name="getContractedServicesofCompany">
            select 
            	   CS.SITE_ID AS SITEKEY,
            	   SI.NAME AS SITENAME, 
            	   SI.CODE AS SITECODE, 
            	   CS.SERVICE_ID AS SERVICEKEY,
            	   SE.NAME AS SERVICENAME, 
            	   SE.CODE AS SERVICECODE, 
            	   CS.COMPANY_ID AS COMPANYKEY,
            	   CO.NAME AS COMPANYNAME,
            	   CO.ENCRYPT,
            	   CO.ENC_PWD AS ENCPWD,
            	   CS.ACTIVE, 
            	   CS.FOLDER_ID AS FOLDERKEY, 
            	   FL.PATH AS FOLDERNAME,
            	   CS.FORMAT_ID AS FORMATKEY,
            	   CS.LAST_MSG AS LASTSENTMESSAGE,
            	   CS.MONITOR,
            	   CS.ACTIVATION AS ACTIVATION,
            	   CS.LAST_MONITORED AS LASTMONITORED,
                   CS.PENDING_MSGS AS PENDINGMESSAGES,
            	   FM.NAME AS FORMATNAME,
            	   CS.WSENDPOINT_ID AS WSENDPOINTKEY,
            	   WS.FULLPATH AS WSENDPOINT,
            	   CS.CUSTOMMAXDELAY_ENDFLOW as CUSTOMMAXDELAYENDFLOW,
            	   cs.compresseddocument as compresseddocument 
            from CONTRACTED_SERVICE AS CS
                  join SERVICE AS SE ON CS.SERVICE_ID = SE.ID
                  join SITE AS SI ON CS.SITE_ID = SI.ID
                  join COMPANY AS CO ON CS.COMPANY_ID = CO.ID
                  join MESSAGEFOLDER AS FL ON CS.FOLDER_ID = FL.ID
                  join MESSAGEFORMAT AS FM ON CS.FORMAT_ID = FM.ID
                  left join WSENDPOINT AS WS ON CS.WSENDPOINT_ID = WS.ID 
            where CO.ID = :companyid
        </sql-query> 
        
        <sql-query name="getContractedServicesofCompanyByRut">
            select distinct
            		SE.ID AS SERVICEKEY,       	   
            	   SE.NAME AS SERVICENAME, 
            	   SE.CODE AS SERVICECODE
            	 
            from CONTRACTED_SERVICE AS CS
                  join SERVICE AS SE ON CS.SERVICE_ID = SE.ID
                  join SITE AS SI ON CS.SITE_ID = SI.ID
                  join COMPANY AS CO ON CS.COMPANY_ID = CO.ID
                  join MESSAGEFOLDER AS FL ON CS.FOLDER_ID = FL.ID
                  join MESSAGEFORMAT AS FM ON CS.FORMAT_ID = FM.ID
                  left join WSENDPOINT AS WS ON CS.WSENDPOINT_ID = WS.ID 
            where CO.RUT = :companyrut AND SE.ID in (5,12)
        </sql-query> 
        
        <sql-query name="getContractedServicesofCompanyRut">
            select 
            	   SI.ID, 
            	   SI.NAME, 
            	   SI.CREATED,
            	   SI.CODE, 
            	   SI.RETAIL_NAME AS RETAILNAME
            from CONTRACTED_SERVICE AS CS    
            	  join SERVICE AS SE ON CS.SERVICE_ID = SE.ID              
                  join SITE AS SI ON CS.SITE_ID = SI.ID
                  join COMPANY AS CO ON CS.COMPANY_ID = CO.ID                   
            where CO.rut = :companyrut AND SE.name = :servicename
        </sql-query>  
        
        
        <sql-query name="getAllContractedServices">
            select 
                 CS.SITE_ID AS SITEKEY,
                 SI.NAME AS SITENAME, 
                 SI.CODE AS SITECODE, 
                 CS.SERVICE_ID AS SERVICEKEY,
                 SE.NAME AS SERVICENAME,
                 SE.CODE AS SERVICECODE,  
                 CS.COMPANY_ID AS COMPANYKEY,
                 CO.NAME AS COMPANYNAME,
                 CO.ENCRYPT,
                 CO.ENC_PWD AS ENCPWD,
                 CS.ACTIVE, 
                 CS.FOLDER_ID AS FOLDERKEY, 
                 FL.PATH AS FOLDERNAME,
                 CS.FORMAT_ID AS FORMATKEY,
                 CS.LAST_MSG AS LASTSENTMESSAGE,
                 CS.MONITOR,
                 CS.ACTIVATION AS ACTIVATION,
                 CS.LAST_MONITORED AS LASTMONITORED,
                 CS.PENDING_MSGS AS PENDINGMESSAGES,
                 FM.NAME AS FORMATNAME,
                 CS.WSENDPOINT_ID AS WSENDPOINTKEY,
            	 WS.FULLPATH AS WSENDPOINT,
            	 CS.CUSTOMMAXDELAY_ENDFLOW as CUSTOMMAXDELAYENDFLOW,
                 cs.compresseddocument as compresseddocument
            from CONTRACTED_SERVICE AS CS
                join SERVICE AS SE ON CS.SERVICE_ID = SE.ID
                join SITE AS SI ON CS.SITE_ID = SI.ID
                join COMPANY AS CO ON CS.COMPANY_ID = CO.ID
                join MESSAGEFOLDER AS FL ON CS.FOLDER_ID = FL.ID
                join MESSAGEFORMAT AS FM ON CS.FORMAT_ID = FM.ID
                left join WSENDPOINT AS WS ON CS.WSENDPOINT_ID = WS.ID 
            order by SITENAME, SERVICENAME, COMPANYNAME
        </sql-query>  

        <sql-query name="getAllContractedServicesBySiteService">
            select
             CS.SITE_ID AS SITEKEY,
             SI.NAME AS SITENAME,
             SI.CODE AS SITECODE, 
             CS.SERVICE_ID AS SERVICEKEY,
             SE.NAME AS SERVICENAME,
             SE.CODE AS SERVICECODE,  
             CS.COMPANY_ID AS COMPANYKEY,
             CO.AS2ID AS AS2ID,
             AC.CODE AS ACCESSCODE,
             CS.MONITOR,
             TOSTR(CS.ACTIVATION) AS ACTIVATION,
             CS.custommaxdelay_endflow as CUSTOMMAXDELAY
             --TOSTR(CS.LAST_MONITORED) AS LASTMONITORED,
             --CS.PENDING_MSGS AS PENDINGMESSAGES
            from CONTRACTED_SERVICE AS CS
                join SERVICE AS SE ON CS.SERVICE_ID = SE.ID
                join SITE AS SI ON CS.SITE_ID = SI.ID
                join COMPANY AS CO ON CS.COMPANY_ID = CO.ID
                join ACCESS AS AC ON CO.ID = AC.COMPANY_ID and SI.ID = AC.SITE_ID
            where CS.SITE_ID = :siteid and CS.SERVICE_ID = :serviceid and CS.MONITOR = true and CS.ACTIVE = true 
            order by CO.ID
        </sql-query> 
               
       
        <sql-query name="getContractedServicesforCustom">
            SELECT	 si.id AS siteid,	 
				 se.id AS serviceid,
				 co.id AS companyid,
				 cs.custom	 
			FROM contracted_service AS cs
				JOIN service  AS se ON cs.service_id = se.id
				JOIN site AS si ON cs.site_id = si.id
				JOIN company AS co ON cs.company_id = co.id
				JOIN access ac ON cs.company_id= ac.company_id and cs.site_id = ac.site_id
			WHERE active = TRUE and CO.rut = :companyrut AND SE.code = :servicecode and SI.name =:sitename
        </sql-query> 
        
        
        <sql-query name="getMonitoredContractedServices">
            select 	distinct si.id AS sitekey, 	 
			 se.id AS servicekey, 	
			 co.id AS companykey,
			 cs.last_monitored AS lastmonitored,
			 cs.custommaxdelay_endflow As custommaxdelayendflow
		from contracted_service AS cs
			join service AS se ON CS.SERVICE_ID = SE.ID
			join site AS si ON CS.SITE_ID = SI.ID
			join company AS co ON CS.COMPANY_ID = CO.ID	
			join service_event AS sevt ON CS.COMPANY_ID = sevt.COMPANY_ID AND CS.SITE_ID = sevt.SITE_ID
			WHERE active = TRUE AND monitor=true and sevt.processed=true AND monitor_type='b2blink'
        </sql-query> 
        
        <sql-query name="UpdateMonitorDateAndPendingMessage">
		UPDATE public.contracted_service
   		SET last_monitored= now(), pending_msgs=1
 		WHERE site_id=:sitekey AND service_id=:servicekey AND company_id=:companykey
		</sql-query>
		
		<sql-query name="UpdateMonitorDate">
		UPDATE public.contracted_service
   		SET last_monitored= now()
 		WHERE site_id=:sitekey AND service_id=:servicekey AND company_id=:companykey
		</sql-query>
       
        </class>
</hibernate-mapping>
