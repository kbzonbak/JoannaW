<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<!-- 
	Mapping file autogenerated by MyEclipse Persistence Tools
-->
<hibernate-mapping>
	<class name="bbr.esb.events.entities.ServiceEvent" table="SERVICE_EVENT" schema="public">
		<id name="id" type="java.lang.Long">
			<column name="ID" />
			<generator class="identity" />
		</id>
		<property name="datecreated" type="java.util.Date" column="DATE_CREATED" length="26" not-null="true" />
		<property name="dateprocessed" type="java.util.Date" column="DATE_PROCESSED" length="26" />
		<property name="processed" type="java.lang.Boolean" column="PROCESSED" not-null="true" />
		<property name="resenddata" type="java.lang.String" column="RESENDDATA" not-null="false" />
		<property name="custom" type="java.lang.String" column="custom" />
		<many-to-one name="site" column="SITE_ID" not-null="true" insert="true" update="true" />
		<many-to-one name="service" column="SERVICE_ID" not-null="true" insert="true" update="true" />
		<many-to-one name="company" column="COMPANY_ID" not-null="true" insert="true" update="true" />
		
		<sql-query name="getUnprocessedServiceEvents">
			select distinct
				   SE.ID AS ID,
				   ST.ID AS SITEKEY,
				   ST.NAME AS SITENAME,
				   ST.CODE AS SITECODE,
				   SV.ID AS SERVICEKEY,
				   SV.NAME AS SERVICENAME,
				   SV.CODE AS SERVICECODE,
				   AC.COMPANY_ID AS COMPANYKEY,
				   AC.CODE AS ACCESSCODE,
				   MF.ID AS FORMATKEY,
				   MF.NAME AS FORMATNAME,
				   SE.RESENDDATA AS RESENDDATA,
				   SE.CUSTOM AS CUSTOM,
				   TOSTR(CS.ACTIVATION) AS ACTIVATION
			from SERVICE_EVENT SE
			join ACCESS AC on SE.SITE_ID = AC.SITE_ID and SE.COMPANY_ID = AC.COMPANY_ID
			join SITE ST on ST.ID = AC.SITE_ID
			join SERVICE SV on SE.SERVICE_ID = SV.ID 
			join CONTRACTED_SERVICE CS on SE.SITE_ID = CS.SITE_ID and CS.SERVICE_ID = SE.SERVICE_ID and SE.COMPANY_ID = CS.COMPANY_ID
			join MESSAGEFORMAT MF on MF.ID = CS.FORMAT_ID 
			where SE.PROCESSED = false
		</sql-query>
		
		
		
		<sql-query name="getServiceEventsOfContract">
SELECT max(date_created) as datecreated, processed, site_id AS sitekey, service_id AS servicekey, company_id AS companykey
       FROM public.service_event
  WHERE site_id=:siteid and company_id=:companyid and service_id=:serviceid
  and (date_created > now()- interval '24 hours')
    group by sitekey,companykey,servicekey,processed


			

		</sql-query>
		
	</class>
</hibernate-mapping>
