<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<!-- 
	Mapping file autogenerated by MyEclipse Persistence Tools
-->
<hibernate-mapping>
	<class
		name="bbr.b2b.walmart.logistic.buyorders.entities.OrderDetail"
		table="ORDERDETAIL"
		entity-name="bbr.b2b.walmart.logistic.buyorders.entities.OrderDetail"
		schema="LOGISTICA">
		<composite-id name="id"
			class="bbr.b2b.walmart.logistic.buyorders.entities.OrderDetailId">
			<key-property name="orderid" access="field"
				type="java.lang.Long" column="ORDER_ID" />
			<key-property name="itemid" access="field"
				type="java.lang.Long" column="ITEM_ID" />
			<key-property name="shippinggroup" access="field"
				type="java.lang.String" column="SHIPPINGGROUP" />
		</composite-id>
		<property name="packagecode" type="java.lang.String"></property>
		<property name="packagedescription" type="java.lang.String"></property>
		<property name="needunits" type="java.lang.Double"></property>
		<property name="receivedunits" type="java.lang.Double"></property>
		<property name="itemnumber" type="java.lang.String" ></property>
		<property name="cost" type="java.lang.Double"></property>
		
		<many-to-one name="order"
			class="bbr.b2b.walmart.logistic.buyorders.entities.Order"
			column="ORDER_ID" not-null="true" insert="false" update="false" />
		<many-to-one name="item"
			class="bbr.b2b.walmart.logistic.items.entities.Item" column="ITEM_ID"
			not-null="true" insert="false" update="false" />

		<sql-query name="doCalculateReceivedOrderDetail">
			<![CDATA[
				WITH foo as 
				(
					SELECT order_id, item_id, 
					SUM(units) as units
					from logistica.receptiondetail
					WHERE order_id in (:orderids)
					GROUP BY order_id, item_id
				)
				UPDATE logistica.orderdetail as od
				SET receivedunits = foo.units
				FROM foo
				WHERE od.order_id = foo.order_id
				AND od.item_id = foo.item_id;
			
			]]>
		</sql-query>
		<sql-query name="findOrderDetailByOrderAndItemAndNumber">
			<![CDATA[	           
	        	SELECT 
  			orderdetail.order_id as orderid, 
			orderdetail.item_id as itemid, 
			  orderdetail.packagecode, 
			  orderdetail.packagedescription, 
			  orderdetail.needunits, 
			  orderdetail.receivedunits, 
			  orderdetail.itemnumber,
			  orderdetail.shippinggroup
			FROM 
			  logistica.orderdetail		
				        	WHERE
				        		order_id = :order and item_id = :item and shippinggroup	= :shippinggroup and itemnumber = :itemnumber	          
			]]>
		</sql-query>

	</class>
</hibernate-mapping>
