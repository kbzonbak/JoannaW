<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<!-- 
	Mapping file autogenerated by MyEclipse Persistence Tools
-->
<hibernate-mapping>
	<class
		name="bbr.b2b.sodimac.logistic.buyorders.entities.Orderdetail"
		table="ORDERDETAIL"
		entity-name="bbr.b2b.sodimac.logistic.buyorders.entities.Orderdetail"
		schema="LOGISTICA">
		<composite-id name="id"
			class="bbr.b2b.sodimac.logistic.buyorders.entities.OrderDetailId">
			<key-property name="orderid" access="field"
				type="java.lang.Long" column="ORDER_ID" />
			<key-property name="itemid" access="field"
				type="java.lang.Long" column="ITEM_ID" />
		</composite-id>
		<property name="linenumber" type="java.lang.Integer"></property>
		<property name="packagecode" type="java.lang.String"></property>
		<property name="umpackage" type="java.lang.String"></property>
		<property name="listprice" type="java.lang.Double"></property>
		<property name="packagesku" type="java.lang.Double"></property>
		<property name="additionalcharge" type="java.lang.Double"></property>
		<property name="additionaldiscount" type="java.lang.Double"></property>
		<property name="totalcharge" type="java.lang.Double"></property>
		<property name="totaldiscount" type="java.lang.Double"></property>
		<property name="needunits" type="java.lang.Double"></property>
		<property name="giftpaper" type="java.lang.Boolean"></property>
		<property name="greeting" type="java.lang.String"></property>
		<property name="upc" type="java.lang.String"></property>
		<property name="unicost" type="java.lang.Double"></property>
		<property name="uniprice" type="java.lang.Double"></property>
		<many-to-one name="order"
			class="bbr.b2b.sodimac.logistic.buyorders.entities.Order"
			column="ORDER_ID" not-null="true" insert="false" update="false" />
		<many-to-one name="item"
			class="bbr.b2b.sodimac.logistic.items.entities.Item" column="ITEM_ID"
			not-null="false" insert="false" update="false" />

		<sql-query name="doCalculateNeedUnitsOrderDetail">
			<![CDATA[
				WITH foo as 
				(
				  SELECT dis.needunits as units, dis.order_id, dis.item_id
				  FROM logistica.distribution dis
				  where dis.order_id = :orderNumber and dis.item_id = :itemSku
				
				)
				UPDATE logistica.orderdetail as od
				SET needunits = foo.units
				FROM foo
				WHERE 
			  	od.order_id = foo.order_id and od.item_id = foo.item_id
			
			]]>
		</sql-query>

		<!--sql-query name="doUpdateOrderDetailNeedUnits">
			<![CDATA[
				UPDATE logistica.orderdetail
				SET needunits=p.needunits
				FROM logistica.predelivery p
				WHERE logistica.orderdetail.order_id = p.order_id and logistica.orderdetail.item_id = p.item_id and p.order_id in (:orders)
			]]>
		</sql-query-->
		
		<sql-query name="doUpdateOrderDetailNeedUnits">
			<![CDATA[
				UPDATE logistica.orderdetail
				SET needunits=p.needunits
				FROM (
				select 
				od.item_id,
				od.order_id,
				sum(p.needunits) needunits
				FROM logistica.predelivery p, logistica.orderdetail od
				WHERE od.order_id = p.order_id 
				and od.item_id = p.item_id 
				and p.order_id in (:orders)
				group by od.item_id, od.order_id) p
				WHERE logistica.orderdetail.order_id = p.order_id and logistica.orderdetail.item_id = p.item_id
			]]>
		</sql-query>
		
		<sql-query name="getById">
			<![CDATA[
				select 	
					linenumber,
					packagecode,
					umpackage,
					listprice,
					packagesku,
					additionalcharge,
					additionaldiscount,
					totalcharge,
					totaldiscount,
					needunits,
					giftpaper,
					greeting,
					upc,
					unicost,
					uniprice,
					order_id orderid,
					item_id itemid 
					from logistica.orderdetail where order_id = :orderid and item_id = :itemid	
			]]>
		</sql-query>

	</class>
</hibernate-mapping>
